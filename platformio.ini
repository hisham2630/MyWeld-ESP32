; MyWeld ESP32-S3 Spot Welder Controller
; Board: JC3248W535 (Guition ESP32-S3, 480x320 TFT, AXS15231B)
; Framework: ESP-IDF 5.x
; Display: esp_lcd + LVGL 9.x

[env:jc3248w535]
platform = espressif32@^6.9.0
board = esp32-s3-devkitc-1
framework = espidf

; --- Board Configuration ---
board_build.mcu = esp32s3
board_build.f_cpu = 240000000L
board_build.flash_mode = qio
board_build.flash_size = 16MB
board_upload.flash_size = 16MB

; --- Partition Table ---
board_build.partitions = partitions.csv

; --- Serial Monitor ---
monitor_speed = 115200
monitor_filters = esp32_exception_decoder, time

; --- Upload ---
upload_speed = 921600

; --- Libraries ---
lib_deps =
    lvgl/lvgl@^9.2.0

; --- Build Flags ---
; CRITICAL: use -DLV_CONF_INCLUDE_SIMPLE instead of -DLV_CONF_SKIP.
;   LV_CONF_SKIP tells LVGL to ignore lv_conf.h completely, so LV_TICK_CUSTOM,
;   LV_COLOR_DEPTH, LV_USE_OS and every other setting is lost → blank screen.
;   LV_CONF_INCLUDE_SIMPLE tells LVGL to find lv_conf.h via the -I src path.
build_flags =
    -DBOARD_HAS_PSRAM
    -DLV_CONF_INCLUDE_SIMPLE
    ; Fonts used by the UI (must match lv_conf.h)
    -DLV_FONT_MONTSERRAT_14=1
    -DLV_FONT_MONTSERRAT_16=1
    -DLV_FONT_MONTSERRAT_20=1
    -DLV_FONT_MONTSERRAT_24=1
    -DLV_FONT_MONTSERRAT_28=1
    -DLV_FONT_MONTSERRAT_36=1
    -DLV_FONT_MONTSERRAT_48=1
    -DLV_USE_THEME_DEFAULT=1
    ; Use standard C allocator (malloc/free) so LVGL buffers can go to PSRAM
    -DLV_USE_STDLIB_MALLOC=LV_STDLIB_CLIB
    ; Disable ARM Helium SIMD (Cortex-M55 only — not available on Xtensa ESP32)
    -DLV_USE_NATIVE_HELIUM_ASM=0
    -DLV_DRAW_SW_ASM=LV_DRAW_SW_ASM_NONE
    -DCORE_DEBUG_LEVEL=5
    -I src

; ============================================================================
; Debug environment — full symbols + halt-on-panic for exception decoding
; Usage: pio run -e debug --target upload && pio device monitor -e debug
; ============================================================================
[env:debug]
extends = env:jc3248w535
; build_type = debug tells PlatformIO to use -Og (debug-friendly optimisation)
; and include full DWARF debug info so esp32_exception_decoder can resolve
; backtrace addresses to file name + line number.
build_type = debug
build_flags =
    ${env:jc3248w535.build_flags}
    -Og
    ; Halt CPU on panic instead of rebooting so the full backtrace
    ; has time to print before the watchdog kicks in.
    -DCONFIG_ESP_SYSTEM_PANIC_PRINT_HALT=1
